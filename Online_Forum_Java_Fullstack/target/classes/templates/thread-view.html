<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>View Thread - Forum App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">Forum App</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/thread}">Threads</a>
            <a class="nav-link" th:href="@{/logout}" sec:authorize="isAuthenticated()">Logout</a>
            <a class="nav-link" th:href="@{/login}" sec:authorize="!isAuthenticated()">Login</a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1>View Thread</h1>

    <!-- Success message after creating or replying -->
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}">Success!</div>

    <!-- If thread not found -->
    <div th:if="${thread == null}" class="alert alert-danger">Thread not found.</div>

    <!-- If thread exists -->
    <div th:if="${thread != null}" class="card">
        <div class="card-header">
            <h2 th:text="${thread.title}">Thread Title</h2>
            <small class="text-muted">
                By <span th:text="${thread.author}">Author</span> in
                <span th:text="${thread.category.name}">Category</span> on
                <span th:text="${#temporals.format(thread.createdAt, 'dd MMM yyyy HH:mm')}">Date</span>
            </small>
        </div>
        <div class="card-body">
            <p th:text="${thread.content}">Thread content goes here.</p>

            <!-- Edit/Delete thread buttons (visible only if the author is current user) -->
            <div sec:authorize="isAuthenticated()">
                <a th:if="${thread.author == #authentication.name}"
                   th:href="@{/thread/{id}/edit(id=${thread.id})}"
                   class="btn btn-warning me-2">Edit Thread</a>

                <form th:if="${thread.author == #authentication.name}"
                      th:action="@{/thread/{id}/delete(id=${thread.id})}"
                      method="post"
                      class="d-inline"
                      onsubmit="return confirm('Delete thread and all replies?')">
                    <button type="submit" class="btn btn-danger">Delete Thread</button>
                </form>
            </div>
        </div>
    </div>

    <hr/>
    <h3>Replies (<span th:text="${posts.size()}">0</span>)</h3>

    <!-- Replies list -->
    <div th:each="post : ${posts}" class="card mb-3">
        <div class="card-body">
            <p th:text="${post.content}">Post content</p>
            <small class="text-muted">
                By <span th:text="${post.author}">Author</span> on
                <span th:text="${#temporals.format(post.createdAt, 'dd MMM yyyy HH:mm')}">Date</span>
            </small>

            <!-- Edit/Delete reply buttons -->
            <div sec:authorize="isAuthenticated()">
                <a th:if="${post.author == #authentication.name}"
                   th:href="@{/post/{id}/edit(id=${post.id})}"
                   class="btn btn-warning btn-sm me-2">Edit Reply</a>

                <form th:if="${post.author == #authentication.name}"
                      th:action="@{/post/{id}/delete(id=${post.id})}"
                      method="post"
                      class="d-inline"
                      onsubmit="return confirm('Delete reply?')">
                    <button type="submit" class="btn btn-danger btn-sm">Delete Reply</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add reply form -->
    <div sec:authorize="isAuthenticated()" class="card mt-4">
        <div class="card-header">
            <h5>Add a Reply</h5>
        </div>
        <div class="card-body">
            <form th:action="@{/thread/{id}/reply(id=${thread.id})}" method="post">  <!-- Change /post to /reply -->
                <div class="mb-3">
                    <label for="content" class="form-label">Your Reply</label>
                    <textarea id="content" name="content" class="form-control" rows="3"
                              placeholder="Write your reply..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Reply</button>
            </form>
        </div>
    </div>

    <div sec:authorize="!isAuthenticated()" class="alert alert-info mt-4">
        Please <a th:href="@{/login}">log in</a> to add a reply.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
